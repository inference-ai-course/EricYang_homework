<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Week3 Voice Agent UI</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 760px; margin: 32px auto; }
    button { padding: 10px 16px; margin-right: 8px; }
    #log { white-space: pre-wrap; background:#f6f6f6; padding:10px; border-radius:8px; }
  </style>
</head>
<body>
  <h1>Voice Agent (Week 3)</h1>
  <p>Click <b>Record</b>, speak, then <b>Stop</b>. Weâ€™ll send audio to <code>/chat/</code> and play the reply.</p>

  <button id="btnRecord">Record</button>
  <button id="btnStop" disabled>Stop</button>
  <audio id="player" controls></audio>

  <h3>Log</h3>
  <div id="log"></div>

  <script>
    const btnRecord = document.getElementById('btnRecord');
    const btnStop   = document.getElementById('btnStop');
    const player    = document.getElementById('player');
    const logEl     = document.getElementById('log');

    let mediaRecorder;
    let chunks = [];

    function log(msg){ logEl.textContent += msg + "\n"; }

    btnRecord.onclick = async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        chunks = [];
        mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) chunks.push(e.data); };
        mediaRecorder.onstop = onStop;
        mediaRecorder.start();
        btnRecord.disabled = true;
        btnStop.disabled = false;
        log("Recording...");
      } catch (e) {
        log("Mic error: " + e);
      }
    };

    btnStop.onclick = () => {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        btnRecord.disabled = false;
        btnStop.disabled = true;
        log("Stopped.");
      }
    };

    async function onStop() {
      const blob = new Blob(chunks, { type: 'audio/wav' }); // many browsers default to webm/ogg; Whisper prefers WAV
      const file = new File([blob], "input.wav", { type: "audio/wav" });

      const form = new FormData();
      form.append("file", file);

      log("Uploading to /chat/...");
      const resp = await fetch("/chat/", { method: "POST", body: form });

      if (!resp.ok) {
        const t = await resp.text();
        log("Server error: " + t);
        return;
      }
      const arrBuf = await resp.arrayBuffer();
      const outBlob = new Blob([arrBuf], { type: "audio/wav" });
      const url = URL.createObjectURL(outBlob);
      player.src = url;
      player.play();
      log("Played assistant reply.");
    }
  </script>
</body>
</html>
